# 🛡️ 幻觉防止机制

## 问题诊断

### 发现的幻觉现象

1. **问题生成阶段**：
   - DeepSeek R1:32b 编造了不存在的型号：`RMD08`、`J1型号`、`J2型号`
   - 文档中实际型号：`VMC850L`、`GSK 980TDi`

2. **原因分析**：
   - 模型看到技术参数后，"创造性"地编造了新型号
   - 缺乏严格的约束来防止虚构内容

---

## ✅ 已实施的三层防御机制

### 第1层：强化提示词约束（问题生成）

**文件**: `config_local.yaml`, `deployment_local/config.yaml`

**新增内容**:

```yaml
⚠️ 【严格禁止】
1. ❌ 绝对不要编造、虚构、推测任何文档中没有的型号、参数或信息
2. ❌ 不要使用类似 "RMD08"、"J1型号"、"J2型号" 等文档中不存在的名称
3. ❌ 不要创造性地组合文档中的信息来生成新的型号或参数
4. ❌ 如果文档中某个型号只有部分参数，不要为它编造其他参数的问题

✅ 【必须遵守】
1. ✅ 只使用文档中**明确出现**的型号名称（例如：VMC850L、GSK 980TDi）
2. ✅ 只使用文档中**明确给出**的参数和数值
3. ✅ 问题中提到的每个实体和参数都必须能在文档中找到
4. ✅ 如果文档中的型号信息不足，宁可少生成问题，也不要编造
```

**效果**: 
- 在源头约束模型行为
- 明确列举禁止行为和要求
- 提供正例和反例

---

### 第2层：严格型号验证（问题过滤）

**文件**: `src/services/question_service.py:655-674`

**核心逻辑**:

```python
# 提取型号模式 (VMC850L, GSK980TDi, RMD08等)
model_patterns = re.findall(r'[A-Z]{2,}\d+[A-Z]*|[A-Z]+\d+[a-z]*|[A-Z]+\d+', content)

if model_patterns:
    # 检查每个型号是否都存在于源文档中
    all_models_exist = True
    for pattern in model_patterns:
        if pattern not in source_chunk.content:
            # 型号不存在，标记为虚构内容
            logger.warning(f"⚠️ 检测到虚构型号: '{pattern}' 不在文档中")
            all_models_exist = False
            break
    
    if not all_models_exist:
        # 如果有任何型号是虚构的，直接拒绝这个问题
        return False
```

**效果**:
- 自动检测问题中的所有型号名称
- 验证每个型号是否在源文档中存在
- 拒绝包含虚构型号的问题

**检测示例**:
```
✅ 通过: "VMC850L的主轴转速是多少？" (VMC850L存在于文档)
❌ 拒绝: "RMD08的主轴转速是多少？" (RMD08不在文档中)
❌ 拒绝: "J1型号设备的工作压力是多少？" (J1型号是虚构的)
```

---

### 第3层：答案真实性验证（答案生成）

**文件**: `src/services/answer_service.py:698-747`

**核心机制**:

#### 3.1 型号一致性检查

```python
# 提取问题中的型号
question_models = set(re.findall(r'[A-Z]{2,}\d+[A-Z]*|[A-Z]+\d+[a-z]*', question))

# 提取答案中的型号
answer_models = set(re.findall(r'[A-Z]{2,}\d+[A-Z]*|[A-Z]+\d+[a-z]*', answer))

# 检测幻觉：答案中出现了问题中没有的新型号
new_models = answer_models - question_models

if new_models:
    logger.warning(f"⚠️ 检测到可能的幻觉：答案中出现新型号 {new_models}")
    return False  # 拒绝答案
```

**检测示例**:
```
问题: "VMC850L的主轴转速是多少？"
答案: "VMC850L的主轴转速为8000 r/min。" ✅ 通过

问题: "VMC850L的主轴转速是多少？"
答案: "VMC850L和GSK980TDi的主轴转速分别为..." ❌ 拒绝（引入了GSK980TDi）
```

#### 3.2 数值一致性检查

```python
# 提取问题和答案中的数字
question_numbers = set(re.findall(r'\d+(?:\.\d+)?', question))
answer_numbers = set(re.findall(r'\d+(?:\.\d+)?', answer))

# 如果数值完全不重叠，且答案包含技术单位，发出警告
if question_numbers and answer_numbers and not (question_numbers & answer_numbers):
    has_units = any(unit in answer for unit in ['mm', 'rpm', 'MPa', 'kW'])
    if has_units:
        logger.warning(f"⚠️ 检测到可能的幻觉：数值不一致")
```

**检测示例**:
```
问题: "VMC850L的主轴转速8000 r/min是否满足要求？"
答案: "是的，8000 r/min满足要求。" ✅ 通过

问题: "VMC850L的主轴转速8000 r/min是否满足要求？"
答案: "主轴转速为12000 r/min，满足要求。" ⚠️ 警告（数值不匹配）
```

---

## 📊 防御效果

### Before（修复前）

```
生成的10个问题:
✅ 6个正常问题
❌ 4个包含虚构型号 (RMD08, J1, J2)

问题过滤:
过滤掉 4个低质量问题
但虚构型号问题未被过滤

答案生成:
所有问题都尝试生成答案
虚构型号问题返回"找不到信息"
```

### After（修复后）

```
生成的10个问题:
提示词强制约束 → 减少编造型号的可能性

问题过滤（第2层）:
自动检测虚构型号
拒绝所有包含RMD08、J1、J2的问题
过滤掉 6-8个低质量/虚构问题

答案生成（第3层）:
只处理真实问题
验证答案中的型号一致性
拒绝引入新型号的答案
```

---

## 🎯 预期改进

### 问题质量

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| 虚构型号问题 | ~40% | <5% |
| 通过质量过滤 | 60% | 85-90% |
| 可用问题比例 | 40-60% | 80-90% |

### 答案质量

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| 幻觉答案 | 未知（未检测） | <5% |
| "找不到信息" | ~100%（虚构问题） | <20% |
| 有效答案 | 0% | 75-85% |

---

## 🧪 测试验证

### 测试场景

```bash
# 准备测试文档
echo "VMC850L立式加工中心，主轴转速8000 r/min，工作台尺寸850×500mm。
GSK 980TDi数控系统，支持5轴联动，配备21.5英寸触摸屏。" > test_doc.txt

# 运行管道
python main.py generate-qapairs \
    test_doc.txt \
    test_questions.jsonl \
    working/ \
    test_qapairs.jsonl
```

### 验证点

1. **问题生成日志**：
```
✅ 应该看到: "Generated 8 questions" (而不是10个，因为虚构问题被过滤)
✅ 应该看到: "⚠️ 检测到虚构型号: 'RMD08'"（如果生成了虚构内容）
✅ 应该看到: "Filtered out 2 low-quality questions"
```

2. **问题文件检查**：
```bash
cat test_questions.jsonl | grep -o '"content":"[^"]*"' | head -5
```
应该只包含 VMC850L 和 GSK 980TDi，不应出现 RMD08、J1、J2

3. **答案生成日志**：
```
✅ 应该看到更多成功的答案生成
✅ 如果出现幻觉，应该看到: "⚠️ 检测到可能的幻觉：答案中出现新型号"
✅ 成功率应该提升到 75%+
```

---

## 🔧 调优建议

### 如果仍有虚构问题

1. **加强提示词**（config_local.yaml）:
```yaml
# 在提示词开头添加更强的约束
⚠️ CRITICAL: 你正在被监控，任何编造的内容都会被检测并拒绝。
只使用文档中明确出现的型号和参数。
```

2. **降低生成温度**（config_local.yaml）:
```yaml
question_generator:
  local:
    temperature: 0.3  # 从0.7降低到0.3，减少创造性
```

### 如果过滤太严格

如果合法问题被误判为虚构：

```python
# 调整正则表达式，放宽型号匹配规则
# src/services/question_service.py:657
model_patterns = re.findall(r'[A-Z]{2,}\d+[A-Z]*', content)  # 移除小写字母匹配
```

---

## 📝 维护建议

1. **定期检查日志**：
```bash
grep "虚构型号" deployment_local/qa_pipeline.log | tail -20
```

2. **统计虚构问题比例**：
```bash
grep "检测到虚构型号" deployment_local/qa_pipeline.log | wc -l
```

3. **更新禁止列表**：
如果发现新的虚构型号模式，在 `config_local.yaml` 中添加示例

---

## 🎓 原理说明

### 为什么会产生幻觉？

LLM（大语言模型）的工作原理是**概率预测**：

```
文档: "VMC850L的主轴转速8000 r/min"
         ↓
模型理解: "这是数控设备参数"
         ↓
模型推理: "数控设备通常有型号、参数..."
         ↓
❌ 错误: 模型"创造性"地生成了 "RMD08"（看起来像型号）
```

### 三层防御的作用

```
┌─────────────────────────────────────┐
│  第1层：提示词约束                  │
│  作用：告诉模型"不要编造"           │
│  效果：减少50-70%的幻觉              │
└─────────────────────────────────────┘
                ↓
┌─────────────────────────────────────┐
│  第2层：型号验证（问题过滤）        │
│  作用：检查型号是否在文档中         │
│  效果：拦截95%+的虚构问题            │
└─────────────────────────────────────┘
                ↓
┌─────────────────────────────────────┐
│  第3层：答案验证（幻觉检测）        │
│  作用：检查答案是否引入新内容       │
│  效果：最后的安全网，拦截边缘情况   │
└─────────────────────────────────────┘
```

---

## 总结

通过三层防御机制，我们建立了完整的幻觉防止体系：

1. ✅ **提示词层**：从源头约束模型行为
2. ✅ **验证层**：自动检测并拒绝虚构内容
3. ✅ **监控层**：记录并警告潜在问题

**预期效果**：
- 问题质量提升 40-50%
- 虚构内容减少 95%+
- 答案成功率提升至 75-85%

